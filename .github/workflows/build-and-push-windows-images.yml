name: Build and push windows images

on:
  workflow_call:
    inputs:
      runner:
        type: string
        required: true
        description: Runner to execute on
      win_edition:
        type: string
        required: true
        description: Windows edition
      vs_version:
        type: string
        required: true
        description: MSVC version
      cuda_version:
        type: string
        required: true
        description: CUDA version
      repo_version:
        type: string
        required: true
        description: Repository version
      push_image:
        type: boolean
        description: Push images only if true

jobs:
  build_windows_image:
    runs-on: ${{ inputs.runner }}
    name: "Build image: ${{ inputs.win_edition }} + VS ${{ inputs.vs_version }} + CUDA ${{ inputs.cuda_version }}"
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Login to ghcr.io
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Login to Docker Hub
        if: ${{ inputs.push_image && vars.DOCKERHUB_REPOSITORY }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.GPUCIBOT_DOCKERHUB_USER }}
          password: ${{ secrets.GPUCIBOT_DOCKERHUB_TOKEN }}

      - name: "Build image: ${{ matrix.win_edition }} + VS${{ matrix.version }}"
        id: build_image
        uses: ./.github/actions/build-windows-image
        with:
          repo: ghcr.io/${{ github.repository }}
          win_edition: ${{ inputs.win_edition }}
          vs_version: ${{ inputs.vs_version }}
          cuda_version: ${{ inputs.cuda_version }}
          repo_version: ${{ inputs.repo_version }}
          isolation: process

      - name: "Test images"
        id: test_image
        uses: ./.github/actions/test-windows-image
        with:
          repo: ghcr.io/${{ github.repository }}
          win_edition: ${{ inputs.win_edition }}
          vs_version: ${{ inputs.vs_version }}
          cuda_version: ${{ inputs.cuda_version }}
          repo_version: ${{ inputs.repo_version }}
          isolation: process

      - name: "Push images to ghcr"
        if: ${{ inputs.push_image }}
        id: push_github
        uses: ./.github/actions/push-windows-image
        with:
          repo: ghcr.io/${{ github.repository }}
          win_edition: ${{ inputs.win_edition }}
          vs_version: ${{ inputs.vs_version }}
          cuda_version: ${{ inputs.cuda_version }}
          repo_version: ${{ inputs.repo_version }}
          isolation: process

      - name: "Push images to dockerhub"
        if: ${{ inputs.push_image && vars.DOCKERHUB_REPOSITORY }}
        id: push_dockerhub
        uses: ./.github/actions/push-windows-image
        with:
          repo: ghcr.io/${{ github.repository }}, ${{ vars.DOCKERHUB_REPOSITORY }}
          win_edition: ${{ inputs.win_edition }}
          vs_version: ${{ inputs.vs_version }}
          cuda_version: ${{ inputs.cuda_version }}
          repo_version: ${{ inputs.repo_version }}
          isolation: process
