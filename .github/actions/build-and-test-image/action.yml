name: build-and-test-image

description: Test image

inputs:
  dir:
    type: string
    required: true
    description: Image dir
  tag:
    type: string
    required: true
    description: Image tag
  arch:
    type: string
    required: true
    description: Image arch

runs:
  using: composite
  steps:

    - if: contains(runner.name, 'rapidsai') != true
      name: Free up disk space
      uses: ./.github/actions/free-disk-space
      with:
        home: "${{ env.HOME }}"
        tool_cache: "${{ runner.tool_cache }}"

    - name: Setup runner environment
      uses: ./.github/actions/setup-runner-env

    - name: Copy common scripts into features
      uses: ./.github/actions/copy-common-scripts

    - name: Build ghcr.io/${{ github.repository }}:${{ inputs.tag }}-${{ inputs.arch }}
      uses: devcontainers/ci@v0.2
      env:
        NODE_NO_WARNINGS: 1
      with:
        push: never
        skipContainerUserIdUpdate: true
        # Skip setting this so skopeo isn't required
        # platform: linux/${{ inputs.arch }}
        subFolder: images/${{ inputs.dir }}
        imageName: ghcr.io/${{ github.repository }}
        imageTag: ${{ inputs.tag }}-${{ inputs.arch }}
        cacheFrom: ghcr.io/${{ github.repository }}:${{ inputs.tag }}-${{ inputs.arch }}
