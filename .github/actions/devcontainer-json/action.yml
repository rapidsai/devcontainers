name: devcontainer-json

description: Make .devcontainer.json

inputs:
  os:
    type: string
    required: true
  features:
    type: string
    required: true
  container_env:
    type: string
    required: false

outputs:
  base_tag:
    value: ${{ steps.json.outputs.base_tag }}
  version:
    value: ${{ steps.json.outputs.version }}

runs:
  using: composite
  steps:

    - id: json
      name: Make image/.devcontainer/devcontainer.json
      shell: bash
      run: |
        bash --noprofile --norc -x -eo pipefail       \
          .github/actions/devcontainer-json/action.sh \
          '${{ inputs.os }}'                          \
          '${{ inputs.features }}'                    \
          '${{ inputs.container_env }}'               \
        3>> "$GITHUB_OUTPUT"                          \
        4> image/.devcontainer/devcontainer.json.out  ;

        mv image/.devcontainer/devcontainer.json{.out,};

        base_tag=$(grep '^base_tag=' "$GITHUB_OUTPUT" | tail -n1 | cut -d= -f2-)
        version=$(grep '^version=' "$GITHUB_OUTPUT" | tail -n1 | cut -d= -f2-)

        echo "base_tag=${base_tag}";
        echo "version=${version}";
        echo -n "devcontainer=";
        cat "image/.devcontainer/devcontainer.json"
